<script type="text/javascript">
    RED.nodes.registerType("aws-secret-manager", {
        category: "AWS",
        color: "#b2e2b2",
        defaults: {
            name: { value: "" },
            awsConfig: { value: "", type: "aws-secret-manager-config", required: true },
            secretId: { value: "" },
            storeIn: { value: "flow" },
            variableName: { value: "" }
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-key",
        label: function() {
            return this.name || "AWS Secrets Manager";
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            // Initialize tooltips
            $('.node-input').tooltip({
                delay: { show: 500, hide: 100 },
                trigger: 'hover'
            });

            // Handle storeIn change
            $("#node-input-storeIn").on("change", function() {
                const storeIn = $(this).val();
                if (storeIn === "env") {
                    $("#variableNameRow").show();
                    $("#variableNameHelp").show();
                } else {
                    $("#variableNameRow").show();
                    $("#variableNameHelp").hide();
                }
            });

            // Validate secret ID format
            $('#node-input-secretId').on('change', function() {
                const value = $(this).val();
                if (value && !/^arn:aws:secretsmanager:[a-z0-9-]+:\d{12}:secret:[a-zA-Z0-9/_+=.@-]+$/.test(value)) {
                    $(this).addClass('input-error');
                    $('#secretId-error').show();
                } else {
                    $(this).removeClass('input-error');
                    $('#secretId-error').hide();
                }
            });

            // Validate variable name format
            $('#node-input-variableName').on('change', function() {
                const value = $(this).val();
                if (value && !/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(value)) {
                    $(this).addClass('input-error');
                    $('#variableName-error').show();
                } else {
                    $(this).removeClass('input-error');
                    $('#variableName-error').hide();
                }
            });
        }
    });
</script>

<script type="text/x-red" data-template-name="aws-secret-manager">
    <div class="form-row">
        <label for="node-input-name">
            <i class="fa fa-tag"></i> Name
        </label>
        <input type="text" id="node-input-name" placeholder="AWS Secrets Manager">
    </div>
    <div class="form-row">
        <label for="node-input-awsConfig">
            <i class="fa fa-key"></i> AWS Credentials
        </label>
        <input type="text" id="node-input-awsConfig">
        <div class="help-text">Select AWS credentials configuration node</div>
    </div>
    <div class="form-row">
        <label for="node-input-secretId">
            <i class="fa fa-lock"></i> Secret ID
        </label>
        <input type="text" id="node-input-secretId" placeholder="arn:aws:secretsmanager:region:account:secret:name">
        <div id="secretId-error" class="error-text" style="display:none;">
            Invalid Secret ID format. Should be a valid AWS Secrets Manager ARN (e.g., arn:aws:secretsmanager:region:account:secret:name) or secret name
        </div>
    </div>
    <div class="form-row">
        <label for="node-input-storeIn">
            <i class="fa fa-database"></i> Store In
        </label>
        <select id="node-input-storeIn">
            <option value="flow">Flow Context</option>
            <option value="global">Global Context</option>
            <option value="env">Environment Variables</option>
            <option value="output">Output Data</option>
        </select>
    </div>
    <div class="form-row" id="variableNameRow">
        <label for="node-input-variableName">
            <i class="fa fa-tag"></i> Variable Name
        </label>
        <input type="text" id="node-input-variableName" placeholder="mySecret">
        <div id="variableName-error" class="error-text" style="display:none;">
            Invalid variable name format. Should start with a letter or underscore
        </div>
    </div>
    <div id="variableNameHelp" class="help-text" style="display:none;">
        For environment variables, each key in the secret will be prefixed with this name
    </div>
</script>

<script type="text/x-red" data-help-name="aws-secret-manager">
    <p>Retrieves secrets from AWS Secrets Manager and stores them in Node-RED context or environment variables.</p>
    <p><b>Input:</b></p>
    <ul>
        <li><code>msg.secretId</code>: Optional Secret ID (if not set in node config)</li>
    </ul>
    <p><b>Output:</b></p>
    <ul>
        <li><code>msg.payload</code>: Contains the secret value</li>
    </ul>
    <p><b>Storage Options:</b></p>
    <ul>
        <li><b>Flow Context</b>: Stores secret in flow context</li>
        <li><b>Global Context</b>: Stores secret in global context</li>
        <li><b>Environment Variables</b>: Stores secret as environment variables</li>
        <li><b>Output Data</b>: Sends secret directly to the output</li>
    </ul>
    <p><b>Best Practices:</b></p>
    <ul>
        <li>Use IAM roles when possible</li>
        <li>Follow the principle of least privilege</li>
        <li>Rotate secrets regularly</li>
        <li>Use environment variables for sensitive data</li>
    </ul>
</script>

<style>
    .help-text {
        font-size: 0.8em;
        color: #666;
        margin-top: 4px;
    }
    .error-text {
        color: #d00;
        font-size: 0.8em;
        margin-top: 4px;
    }
    .input-error {
        border-color: #d00 !important;
    }
    .form-row {
        margin-bottom: 10px;
    }
</style>

<script type="text/javascript">
    $(function() {
        // Populate the config dropdown
        var configNodes = RED.nodes.filterNodes({type:"aws-secret-manager-config"});
        var configSelect = $("#node-input-awsConfig");
        configSelect.empty();
        configSelect.append($("<option></option>").attr("value","").text("Select AWS Config"));
        configNodes.forEach(function(node) {
            configSelect.append($("<option></option>").attr("value",node.id).text(node.name));
        });
    });
</script> 